<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Textbook Companion</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
          --primary: #25D366;
          --primary-light: #DCF8C6;
          --primary-dark: #128C7E;
          --secondary: #34B7F1;
          --gray-100: #f0f2f5;
          --gray-200: #e9edef;
          --gray-300: #d1d7db;
          --gray-400: #aebac1;
          --gray-500: #8696a0;
          --gray-600: #667781;
          --gray-700: #3b4a54;
          --gray-800: #111b21;
          --warning: #f59e0b;
          --error: #ef4444;
          --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
          --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
          --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
          --radius-sm: 0.375rem;
          --radius-md: 0.5rem;
          --radius-lg: 0.75rem;
        }

        * {
          box-sizing: border-box;
          margin: 0;
          padding: 0;
        }

        body {
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
          background-color: #e5ddd5;
          color: var(--gray-800);
          line-height: 1.5;
          height: 100vh;
          display: flex;
          flex-direction: column;
        }

        .container {
          max-width: 100%;
          height: 100vh;
          margin: 0 auto;
          display: flex;
          flex-direction: column;
          background-color: #e5ddd5;
          background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%239C92AC' fill-opacity='0.05' fill-rule='evenodd'/%3E%3C/svg%3E");
        }

        /* Upload screen */
        .upload-screen {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          height: 100%;
          padding: 2rem;
          text-align: center;
        }

        .upload-screen h1 {
          font-size: 2rem;
          color: var(--gray-800);
          margin-bottom: 1rem;
        }

        .upload-screen p {
          color: var(--gray-600);
          font-size: 1rem;
          max-width: 36rem;
          margin-bottom: 2rem;
        }

        /* Chat screen (hidden by default) */
        .chat-screen {
          display: none;
          flex-direction: column;
          height: 100%;
          background-color: var(--gray-100);
          max-width: 800px;
          margin: 0 auto;
          width: 100%;
          border-radius: 8px;
          overflow: hidden;
          box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        /* Chat header */
        .chat-header {
          background-color: var(--primary-dark);
          color: white;
          padding: 1rem;
          display: flex;
          align-items: center;
          gap: 1rem;
          position: sticky;
          top: 0;
          z-index: 10;
        }

        .chat-header-icon {
          background-color: white;
          width: 40px;
          height: 40px;
          border-radius: 50%;
          display: flex;
          align-items: center;
          justify-content: center;
          color: var(--primary-dark);
        }

        .chat-header-info h2 {
          font-size: 1.1rem;
          font-weight: 500;
        }

        .chat-header-info p {
          font-size: 0.8rem;
          opacity: 0.8;
        }

        /* Chat messages */
        .chat-messages {
          flex: 1;
          padding: 1rem;
          overflow-y: auto;
          display: flex;
          flex-direction: column;
          gap: 0.5rem;
          scroll-behavior: smooth;
        }

        .message {
          max-width: 80%;
          padding: 0.75rem 1rem;
          border-radius: var(--radius-md);
          font-size: 0.95rem;
          line-height: 1.4;
          position: relative;
          animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; transform: translateY(10px); }
          to { opacity: 1; transform: translateY(0); }
        }

        .message-user {
          background-color: var(--primary-light);
          align-self: flex-end;
          border-top-right-radius: var(--radius-sm);
          margin-left: auto;
        }

        .message-textbook {
          background-color: white;
          align-self: flex-start;
          border-top-left-radius: var(--radius-sm);
          box-shadow: var(--shadow-sm);
        }

        .message-meta {
          display: flex;
          justify-content: flex-end;
          margin-top: 0.25rem;
          font-size: 0.7rem;
          color: var(--gray-600);
        }

        .message-user .message-meta {
          color: var(--gray-700);
        }

        .message-time {
          font-size: 0.7rem;
          color: var(--gray-500);
          margin-top: 0.25rem;
          text-align: right;
        }

        .typing-indicator {
          display: flex;
          padding: 0.75rem 1rem;
          background-color: white;
          border-radius: var(--radius-md);
          align-self: flex-start;
          border-top-left-radius: var(--radius-sm);
          box-shadow: var(--shadow-sm);
          width: fit-content;
          gap: 0.5rem;
        }

        .typing-dot {
          width: 8px;
          height: 8px;
          background: var(--gray-400);
          border-radius: 50%;
          animation: typingAnimation 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
          animation-delay: 0s;
        }

        .typing-dot:nth-child(2) {
          animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
          animation-delay: 0.4s;
        }

        @keyframes typingAnimation {
          0%, 60%, 100% { transform: translateY(0); }
          30% { transform: translateY(-5px); }
        }

        /* Chat input */
        .chat-input-container {
          padding: 0.75rem;
          background-color: var(--gray-200);
          display: flex;
          gap: 0.5rem;
          position: sticky;
          bottom: 0;
        }

        .chat-input {
          flex: 1;
          padding: 0.75rem 1rem;
          border: none;
          border-radius: var(--radius-lg);
          font-size: 0.95rem;
          background-color: white;
          outline: none;
        }

        .chat-input:focus {
          box-shadow: 0 0 0 2px var(--primary);
        }

        .send-btn {
          background-color: var(--primary);
          color: white;
          border: none;
          border-radius: 50%;
          width: 40px;
          height: 40px;
          display: flex;
          align-items: center;
          justify-content: center;
          cursor: pointer;
          transition: background-color 0.2s;
        }

        .send-btn:hover {
          background-color: var(--primary-dark);
        }

        .send-btn:disabled {
          background-color: var(--gray-300);
          cursor: not-allowed;
        }

        /* Upload card */
        .upload-card {
          background: white;
          border-radius: var(--radius-lg);
          box-shadow: var(--shadow-md);
          padding: 2rem;
          width: 100%;
          max-width: 500px;
          transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .upload-card:hover {
          box-shadow: var(--shadow-lg);
          transform: translateY(-2px);
        }

        .upload-card h2 {
          font-weight: 600;
          font-size: 1.25rem;
          color: var(--gray-800);
          margin-bottom: 1.5rem;
          display: flex;
          align-items: center;
          gap: 0.75rem;
        }

        .upload-card h2 svg {
          width: 1.5rem;
          height: 1.5rem;
          color: var(--primary-dark);
        }

        /* File upload styles */
        .file-input-container {
          position: relative;
          margin-bottom: 1.5rem;
        }

        .file-input-label {
          display: flex;
          flex-direction: column;
          align-items: center;
          justify-content: center;
          padding: 2rem;
          border: 2px dashed var(--gray-300);
          border-radius: var(--radius-md);
          background-color: var(--gray-100);
          cursor: pointer;
          transition: all 0.2s ease;
        }

        .file-input-label:hover {
          border-color: var(--primary);
          background-color: rgba(37, 211, 102, 0.05);
        }

        .file-input-label.dragover {
          border-color: var(--primary);
          background-color: rgba(37, 211, 102, 0.1);
        }

        .file-input-label svg {
          width: 2.5rem;
          height: 2.5rem;
          color: var(--primary);
          margin-bottom: 1rem;
        }

        .file-input-label-text {
          font-weight: 500;
          color: var(--gray-700);
          margin-bottom: 0.5rem;
          text-align: center;
        }

        .file-input-label-subtext {
          font-size: 0.875rem;
          color: var(--gray-600);
          text-align: center;
        }

        .file-input {
          position: absolute;
          width: 0.1px;
          height: 0.1px;
          opacity: 0;
          overflow: hidden;
          z-index: -1;
        }

        .selected-file {
          display: flex;
          align-items: center;
          gap: 0.75rem;
          background-color: var(--gray-100);
          padding: 0.75rem 1rem;
          border-radius: var(--radius-sm);
          margin-top: 1rem;
          font-size: 0.875rem;
        }

        .selected-file svg {
          width: 1.25rem;
          height: 1.25rem;
          color: var(--primary-dark);
        }

        .selected-file-name {
          flex-grow: 1;
          white-space: nowrap;
          overflow: hidden;
          text-overflow: ellipsis;
        }

        .remove-file {
          background: none;
          border: none;
          color: var(--gray-600);
          cursor: pointer;
          padding: 0.25rem;
        }

        .remove-file:hover {
          color: var(--gray-800);
        }

        .upload-btn {
          display: inline-flex;
          align-items: center;
          justify-content: center;
          gap: 0.5rem;
          width: 100%;
          padding: 0.875rem 1.5rem;
          font-size: 1rem;
          font-weight: 500;
          border: none;
          border-radius: var(--radius-md);
          cursor: pointer;
          transition: all 0.2s ease;
          background-color: var(--primary-dark);
          color: white;
        }

        .upload-btn:hover:not(:disabled) {
          background-color: #0e7a6e;
          transform: translateY(-1px);
        }

        .upload-btn:active:not(:disabled) {
          transform: translateY(0);
        }

        .upload-btn:disabled {
          background-color: var(--gray-300);
          cursor: not-allowed;
          opacity: 0.7;
        }

        /* Toast notification */
        .toast {
          position: fixed;
          bottom: 1.5rem;
          left: 50%;
          transform: translateX(-50%);
          background-color: var(--gray-800);
          color: white;
          padding: 0.75rem 1.5rem;
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-lg);
          display: flex;
          align-items: center;
          gap: 0.75rem;
          z-index: 1000;
          opacity: 0;
          transition: opacity 0.3s ease;
          max-width: 90%;
        }

        .toast.show {
          opacity: 1;
        }

        .toast-success {
          background-color: var(--primary);
        }

        .toast-error {
          background-color: var(--error);
        }

        .toast-warning {
          background-color: var(--warning);
        }

        .toast svg {
          width: 1.25rem;
          height: 1.25rem;
        }

        /* Spinner */
        .spinner {
          width: 1.25rem;
          height: 1.25rem;
          border: 2px solid var(--gray-200);
          border-top-color: var(--primary);
          border-radius: 50%;
          animation: spin 1s linear infinite;
        }

        @keyframes spin {
          to { transform: rotate(360deg); }
        }

        /* Page reference */
        .page-reference {
          font-size: 0.8rem;
          color: var(--gray-600);
          margin-top: 0.5rem;
          display: flex;
          align-items: center;
          gap: 0.25rem;
        }

        .page-reference svg {
          width: 1rem;
          height: 1rem;
        }

        /* Source items */
        .source-item {
          padding: 1rem 0;
          border-bottom: 1px solid var(--gray-100);
        }

        .source-header {
          display: flex;
          align-items: center;
          margin-bottom: 0.5rem;
        }

        .source-page {
          display: inline-block;
          background-color: var(--primary-light);
          color: var(--primary-dark);
          font-size: 0.75rem;
          padding: 0.25rem 0.5rem;
          border-radius: 9999px;
          margin-right: 0.5rem;
          font-weight: 500;
        }

        .source-view-btn {
          background: none;
          border: none;
          color: var(--primary);
          cursor: pointer;
          font-size: 0.8rem;
          margin-left: 0.5rem;
        }

        .source-text {
          margin-top: 0.5rem;
          padding: 0.5rem;
          background: var(--gray-100);
          border-radius: var(--radius-sm);
          font-size: 0.9rem;
        }

        /* PDF Preview */
        #pdf-preview {
          display: none;
          margin-top: 1.5rem;
          background: white;
          padding: 1.5rem;
          border-radius: var(--radius-md);
          box-shadow: var(--shadow-sm);
        }

        #pdf-preview h3 {
          margin-bottom: 1rem;
          color: var(--gray-800);
        }

        #pdf-preview-content {
          margin-bottom: 1rem;
          border: 1px solid var(--gray-200);
          border-radius: var(--radius-sm);
          overflow: hidden;
        }

        #confirm-upload {
          background-color: var(--primary);
          color: white;
          border: none;
          padding: 0.75rem 1.5rem;
          border-radius: var(--radius-md);
          cursor: pointer;
          font-weight: 500;
          transition: background-color 0.2s;
        }

        #confirm-upload:hover {
          background-color: var(--primary-dark);
        }

        /* Responsive adjustments */
        @media (max-width: 640px) {
          .upload-screen h1 {
            font-size: 1.5rem;
          }

          .upload-screen p {
            font-size: 0.9rem;
          }

          .upload-card {
            padding: 1.5rem;
          }

          .chat-header {
            padding: 0.75rem;
          }

          .message {
            max-width: 90%;
          }
        }

        /* Accessibility focus styles */
        button:focus, input:focus {
          outline: 2px solid var(--primary);
          outline-offset: 2px;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Upload Screen (visible by default) -->
    <div class="upload-screen" id="upload-screen">
        <h1>Academic Textbook Companion</h1>
        <p>Upload your textbook PDF to start chatting with it like WhatsApp</p>

        <div class="upload-card">
            <h2>
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Upload Your Textbook
            </h2>
            <form id="upload-form">
                <div class="file-input-container">
                    <input type="file" id="file" class="file-input" accept=".pdf" required aria-label="Select PDF file" />
                    <label for="file" class="file-input-label" id="file-input-label">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
                        </svg>
                        <span class="file-input-label-text">Drag & drop your textbook PDF here</span>
                        <span class="file-input-label-subtext">or click to browse files (max 10MB)</span>
                    </label>
                    <div id="selected-file-container" style="display: none;">
                        <div class="selected-file">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            <span class="selected-file-name" id="selected-file-name"></span>
                            <button type="button" class="remove-file" id="remove-file" aria-label="Remove file">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
                <div id="pdf-preview">
                    <h3>Document Preview</h3>
                    <div id="pdf-preview-content"></div>
                    <button type="button" id="confirm-upload">Confirm Upload</button>
                </div>
                <button type="submit" class="upload-btn" id="upload-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" width="20" height="20">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Upload & Start Chatting
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Screen (hidden by default) -->
    <div class="chat-screen" id="chat-screen">
        <div class="chat-header">
            <div class="chat-header-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="24" height="24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
            </div>
            <div class="chat-header-info">
                <h2>Textbook Companion</h2>
                <p>Online</p>
            </div>
        </div>

        <div class="chat-messages" id="chat-messages" aria-live="polite" aria-atomic="false">
            <!-- Messages will be inserted here -->
            <div class="message message-textbook">
                Hi there! I'm your textbook companion. Ask me anything about the material you've uploaded.
                <div class="message-meta">Textbook Companion • Just now</div>
            </div>
        </div>

        <div class="chat-input-container">
            <input type="text" class="chat-input" id="chat-input" placeholder="Type your question about the material..."
                   aria-label="Type your question" aria-required="true" />
            <button class="send-btn" id="send-btn" disabled aria-label="Send message">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="24" height="24">
                    <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
                </svg>
            </button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Elements
        const elements = {
            uploadScreen: document.getElementById("upload-screen"),
            chatScreen: document.getElementById("chat-screen"),
            uploadForm: document.getElementById("upload-form"),
            fileInput: document.getElementById("file"),
            fileInputLabel: document.getElementById("file-input-label"),
            selectedFileContainer: document.getElementById("selected-file-container"),
            selectedFileName: document.getElementById("selected-file-name"),
            removeFileBtn: document.getElementById("remove-file"),
            uploadBtn: document.getElementById("upload-btn"),
            chatMessages: document.getElementById("chat-messages"),
            chatInput: document.getElementById("chat-input"),
            sendBtn: document.getElementById("send-btn"),
            toast: document.getElementById("toast"),
            pdfPreview: document.getElementById("pdf-preview"),
            pdfPreviewContent: document.getElementById("pdf-preview-content"),
            confirmUploadBtn: document.getElementById("confirm-upload")
        };

        // State
        const state = {
            pdfUploaded: false,
            sessionId: crypto.randomUUID(),
            conversationHistory: [],
            lastRequestTime: 0,
            REQUEST_DELAY: 2000
        };

        // Initialize the app
        init();

        function init() {
            try {
                loadConversationHistory();
                setupEventListeners();
            } catch (error) {
                console.error("Initialization error:", error);
                showToast("Error initializing application", "error");
            }
        }

        function setupEventListeners() {
            // File input handling
            elements.fileInputLabel.addEventListener("dragover", handleDragOver);
            elements.fileInputLabel.addEventListener("dragleave", handleDragLeave);
            elements.fileInputLabel.addEventListener("drop", handleDrop);
            elements.fileInput.addEventListener("change", handleFileChange);
            elements.removeFileBtn.addEventListener("click", handleRemoveFile);

            // Form submissions
            elements.uploadForm.addEventListener("submit", handleUploadSubmit);
            elements.confirmUploadBtn.addEventListener("click", handleConfirmUpload);

            // Chat interactions
            elements.chatInput.addEventListener("input", handleChatInput);
            elements.sendBtn.addEventListener("click", handleSendMessage);
            elements.chatInput.addEventListener("keypress", (e) => {
                if (e.key === "Enter") handleSendMessage();
            });
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            elements.fileInputLabel.classList.add("dragover");
        }

        function handleDragLeave() {
            elements.fileInputLabel.classList.remove("dragover");
        }

        function handleDrop(e) {
            e.preventDefault();
            elements.fileInputLabel.classList.remove("dragover");
            if (e.dataTransfer.files.length) {
                elements.fileInput.files = e.dataTransfer.files;
                handleFileChange();
            }
        }

        // File validation
        function isValidPDF(file) {
            const validTypes = ['application/pdf'];
            const maxSize = 10 * 1024 * 1024; // 10MB
            return file && validTypes.includes(file.type) && file.size <= maxSize;
        }

        // File change handler
        function handleFileChange() {
            if (elements.fileInput.files.length) {
                const file = elements.fileInput.files[0];

                if (!isValidPDF(file)) {
                    showToast("Please upload a valid PDF file (max 10MB)", "error");
                    elements.fileInput.value = "";
                    return;
                }

                elements.selectedFileName.textContent = file.name;
                elements.selectedFileContainer.style.display = "block";
                elements.pdfPreview.style.display = "block";
            }
        }

        // Remove file handler
        function handleRemoveFile() {
            elements.fileInput.value = "";
            elements.selectedFileContainer.style.display = "none";
            elements.pdfPreview.style.display = "none";
        }

        // Confirm upload handler
        function handleConfirmUpload() {
            elements.uploadForm.dispatchEvent(new Event('submit'));
        }

        // Upload PDF handler
        async function handleUploadSubmit(e) {
            e.preventDefault();
            if (!elements.fileInput.files?.length) {
                showToast("Please select a PDF file to upload.", "error");
                return;
            }

            const file = elements.fileInput.files[0];
            if (!isValidPDF(file)) {
                showToast("Invalid PDF file. Please upload a valid PDF document (max 10MB).", "error");
                return;
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("sessionId", state.sessionId);

            showLoadingState(elements.uploadBtn, "Processing...");

            try {
                const res = await fetch("/api/pdf/upload", {
                    method: "POST",
                    body: formData
                });

                // Handle response properly whether it's JSON or plain text
                let responseData;
                const contentType = res.headers.get('content-type');
                if (contentType && contentType.includes('application/json')) {
                    responseData = await res.json();
                } else {
                    responseData = { message: await res.text() };
                }

                if (!res.ok) {
                    throw new Error(responseData.message || "Upload failed");
                }

                showToast("Textbook uploaded successfully! Starting chat...", "success");
                state.pdfUploaded = true;
                switchToChatInterface();

            } catch (err) {
                console.error("Upload error:", err);
                let errorMsg = err.message;
                // Handle specific error cases
                if (err.message.includes("PDF") || err.message.includes("Unexpected token")) {
                    errorMsg = "Invalid PDF file. Please upload a valid PDF document.";
                }
                showToast(`Upload error: ${errorMsg}`, "error");
            } finally {
                hideLoadingState(elements.uploadBtn, "Upload & Start Chatting");
            }
        }

        function switchToChatInterface() {
            elements.uploadScreen.style.display = "none";
            elements.chatScreen.style.display = "flex";
            elements.fileInput.value = "";
            elements.selectedFileContainer.style.display = "none";
            elements.pdfPreview.style.display = "none";
        }

        // Chat input handler
        function handleChatInput() {
            elements.sendBtn.disabled = !elements.chatInput.value.trim();
        }

        // Send message handler
        async function handleSendMessage() {
            const now = Date.now();
            if (now - state.lastRequestTime < state.REQUEST_DELAY) {
                showToast("Please wait a moment before sending another question", "warning");
                return;
            }
            state.lastRequestTime = now;

            const question = elements.chatInput.value.trim();
            if (!question) return;

            // Add user message to chat and history
            addMessage(question, "user");
            addToHistory("user", question);

            // Clear input and disable send button
            elements.chatInput.value = "";
            elements.sendBtn.disabled = true;

            // Show typing indicator
            showTypingIndicator();

            try {
                // Send question to API endpoint
                const response = await fetch('/qa/ask', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        question: question,
                        sessionId: state.sessionId
                    })
                });

                const data = await response.json();

                if (response.ok && data.answer) {
                    // Add textbook response with page references if available
                    addMessage(data.answer, "textbook", data.sources);
                    addToHistory("textbook", data.answer, data.sources);

                    // Track successful question
                    trackEvent('question_asked', {
                        question_length: question.length,
                        response_length: data.answer.length,
                        has_sources: !!data.sources
                    });
                } else {
                    const errorMsg = data.error || "Failed to get answer from the material";
                    addMessage(errorMsg, "textbook");
                    addToHistory("textbook", errorMsg);

                    trackEvent('question_error', {
                        error: errorMsg
                    });
                }
            } catch (err) {
                const errorMsg = err.message.includes("aborted") ?
                    "Request timed out. Please try again." :
                    "Network error. Please check your connection.";

                addMessage(errorMsg, "textbook");
                addToHistory("textbook", errorMsg);

                trackEvent('network_error', {
                    error: err.message
                });
            } finally {
                removeTypingIndicator();
            }
        }

        // Add message to chat
        function addMessage(text, sender, sources = null, scroll = true) {
            const messageDiv = document.createElement("div");
            messageDiv.className = `message message-${sender}`;

            const messageContent = document.createElement("div");
            messageContent.textContent = text;
            messageDiv.appendChild(messageContent);

            const metaDiv = document.createElement("div");
            metaDiv.className = "message-meta";

            if (sender === "user") {
                metaDiv.textContent = `You • ${formatTime(new Date())}`;
            } else {
                // Add page reference if sources are available
                if (sources && sources.length > 0) {
                    const pageRef = document.createElement("div");
                    pageRef.className = "page-reference";
                    pageRef.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                        Based on page ${sources[0].page || 'N/A'}
                    `;
                    messageDiv.appendChild(pageRef);

                    // Add view source button
                    const viewSourceBtn = document.createElement("button");
                    viewSourceBtn.className = "source-view-btn";
                    viewSourceBtn.textContent = "View Source";
                    viewSourceBtn.onclick = () => showSources(sources);
                    messageDiv.appendChild(viewSourceBtn);
                }
                metaDiv.textContent = `Textbook Companion • ${formatTime(new Date())}`;
            }

            messageDiv.appendChild(metaDiv);
            elements.chatMessages.appendChild(messageDiv);

            // Scroll to bottom if requested
            if (scroll) {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }
        }

        // Show sources in a modal (simplified)
        function showSources(sources) {
            const sourcesHTML = sources.map(source => `
                <div class="source-item">
                    <div class="source-header">
                        <span class="source-page">Page ${source.page || 'N/A'}</span>
                    </div>
                    <div class="source-text">${source.text}</div>
                </div>
            `).join("");

            alert(`Sources:\n\n${sources.map(s => `Page ${s.page}: ${s.text}`).join("\n\n")}`);
            // In a real app, you'd use a proper modal here
        }

        // Add message to history
        function addToHistory(role, content, sources = []) {
            state.conversationHistory.push({
                role,
                content,
                sources,
                timestamp: new Date().toISOString()
            });

            // Persist to localStorage
            localStorage.setItem('conversationHistory', JSON.stringify(state.conversationHistory));
        }

        // Show typing indicator
        function showTypingIndicator() {
            const typingDiv = document.createElement("div");
            typingDiv.className = "typing-indicator";
            typingDiv.id = "typing-indicator";
            typingDiv.innerHTML = `
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            `;
            elements.chatMessages.appendChild(typingDiv);
            elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
        }

        // Remove typing indicator
        function removeTypingIndicator() {
            const typingIndicator = document.getElementById("typing-indicator");
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        // Show loading state
        function showLoadingState(button, text) {
            button.disabled = true;
            button.innerHTML = `<span class="spinner"></span> ${text}`;
        }

        // Hide loading state
        function hideLoadingState(button, originalText) {
            button.disabled = false;
            button.innerHTML = originalText;
        }

        // Format time for display
        function formatTime(date) {
            return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        // Load conversation history from localStorage
        function loadConversationHistory() {
            const savedHistory = localStorage.getItem('conversationHistory');
            if (savedHistory) {
                state.conversationHistory = JSON.parse(savedHistory);
                renderHistory();
            }
        }

        // Render conversation history
        function renderHistory() {
            elements.chatMessages.innerHTML = '';
            state.conversationHistory.forEach(msg => {
                addMessage(msg.content, msg.role, msg.sources, false);
            });
        }

        // Toast notification function
        function showToast(message, type = "info") {
            elements.toast.textContent = message;
            elements.toast.className = "toast";
            elements.toast.classList.add(`toast-${type}`);
            elements.toast.classList.add("show");

            // Add icon based on type
            let iconPath = "";
            if (type === "success") {
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />`;
            } else if (type === "error") {
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />`;
            } else if (type === "warning") {
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />`;
            } else {
                iconPath = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />`;
            }

            elements.toast.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="20" height="20">${iconPath}</svg> ${message}`;

            setTimeout(() => {
                elements.toast.classList.remove("show");
            }, 3000);
        }

        // Analytics tracking
        function trackEvent(eventName, metadata = {}) {
            // In a real app, you'd send this to your analytics service
            console.log('Event:', eventName, metadata);

            // Example using gtag (Google Analytics)
            if (typeof gtag !== 'undefined') {
                gtag('event', eventName, metadata);
            }
        }
    });
</script>
</body>
</html>